From 7000cec176ebb84b79e33f0cc7235a278f222e19 Mon Sep 17 00:00:00 2001
From: Matthew Nelson <developer@matthewnelson.io>
Date: Wed, 4 Oct 2023 07:59:56 -0400
Subject: [PATCH 11/11] Replace getentropy with SecRandomCopyBytes

---
 Makefile                 |  1 +
 Makefile.common          |  6 +++---
 sec_random_copy_bytes.sh | 22 ++++++++++++++++++++++
 3 files changed, 26 insertions(+), 3 deletions(-)
 create mode 100755 sec_random_copy_bytes.sh

diff --git a/Makefile b/Makefile
index bdb31d7..e11f983 100644
--- a/Makefile
+++ b/Makefile
@@ -39,6 +39,7 @@ $(SQLITE_UNPACKED): $(SQLITE_ARCHIVE)
 	unzip -qo $< -d $(TARGET)/tmp.$(version)
 	(mv $(TARGET)/tmp.$(version)/$(SQLITE_AMAL_PREFIX) $(TARGET) && rmdir $(TARGET)/tmp.$(version)) || mv $(TARGET)/tmp.$(version)/ $(TARGET)/$(SQLITE_AMAL_PREFIX)
 	touch $@
+    $(shell ./sec_random_copy_bytes.sh)
 
 
 $(TARGET)/common-lib/org/sqlite/%.class: src/main/java/org/sqlite/%.java
diff --git a/Makefile.common b/Makefile.common
index e992cb2..9f692d2 100644
--- a/Makefile.common
+++ b/Makefile.common
@@ -220,8 +220,8 @@ MAC_SDK := /Developer/SDKs/MacOSX10.10.sdk
 ifeq ($(wildcard MAC_SDK),)
 	MAC_SDK := /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.12.sdk
 endif
-Mac-x86_64_CCFLAGS    := -I$(MAC_SDK)/System/Library/Frameworks/JavaVM.framework/Headers -Ilib/inc_mac -Os -fPIC -mmacosx-version-min=10.6 -fvisibility=hidden -Wno-implicit-function-declaration -msse4.2 -maes
-Mac-x86_64_LINKFLAGS := -dynamiclib 
+Mac-x86_64_CCFLAGS    := -I$(MAC_SDK)/System/Library/Frameworks/JavaVM.framework/Headers -Ilib/inc_mac -Os -fPIC -mmacosx-version-min=10.7 -fvisibility=hidden -Wno-implicit-function-declaration -msse4.2 -maes
+Mac-x86_64_LINKFLAGS := -dynamiclib -framework Security
 Mac-x86_64_LIBNAME   := libsqlitejdbc.dylib
 Mac-x86_64_SQLITE_FLAGS  := 
 
@@ -231,7 +231,7 @@ Mac-aarch64_CC        := $(CROSS_PREFIX)clang
 Mac-aarch64_STRIP     := $(CROSS_PREFIX)strip -x
 MAC_SDK := /usr/osxcross/SDK/MacOSX11.3.sdk
 Mac-aarch64_CCFLAGS    := -I$(MAC_SDK)/System/Library/Frameworks/JavaVM.framework/Headers -Ilib/inc_mac -Os -fPIC -mmacosx-version-min=10.9 -fvisibility=hidden -Wno-implicit-function-declaration
-Mac-aarch64_LINKFLAGS  := -dynamiclib
+Mac-aarch64_LINKFLAGS  := -dynamiclib -framework Security
 Mac-aarch64_LIBNAME    := libsqlitejdbc.dylib
 Mac-aarch64_SQLITE_FLAGS := 
 
diff --git a/sec_random_copy_bytes.sh b/sec_random_copy_bytes.sh
new file mode 100755
index 0000000..3da9bd6
--- /dev/null
+++ b/sec_random_copy_bytes.sh
@@ -0,0 +1,22 @@
+#!/usr/bin/env bash
+
+# Replaces the implementation of
+#
+#     static size_t entropy(void* buf, size_t n)
+#
+# for Darwin with usage of SecRandomCopyBytes
+#
+# See https://github.com/utelle/SQLite3MultipleCiphers/issues/118
+# See https://github.com/toxicity-io/sqlite-mc/issues/39
+
+readonly DIR_SCRIPT=$( cd "$( dirname "$0" )" >/dev/null && pwd )
+
+DIR_AMAL=
+for DIR_AMAL in "$DIR_SCRIPT/target/sqlite-amalgamation-"*; do
+  break
+done
+
+sed -iv 's|#if defined(__APPLE__) && defined(__MAC_10_12) && !defined(__IPHONE_OS_VERSION_MIN_REQUIRED)|#if defined(__APPLE__)|' "$DIR_AMAL/sqlite3mc_amalgamation.c"
+sed -iv 's|#include <sys/random.h>|#include <Security/SecRandom.h>|' "$DIR_AMAL/sqlite3mc_amalgamation.c"
+sed -iv 's|#if defined(__APPLE__) && defined(__MAC_10_12) && __MAC_OS_X_VERSION_MAX_ALLOWED >= __MAC_10_12|#if defined(__APPLE__)|' "$DIR_AMAL/sqlite3mc_amalgamation.c"
+sed -iv 's|  if (getentropy(buf, n) == 0)|  if (SecRandomCopyBytes(kSecRandomDefault, n, (uint8_t*) buf) == 0)|' "$DIR_AMAL/sqlite3mc_amalgamation.c"
-- 
2.34.1

